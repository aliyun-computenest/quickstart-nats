<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="计算巢是阿里云开放给企业应用服务商的服务管理平台。服务商能够在计算巢上发布私有化部署服务，为其客户提供云上软件一键部署的能力；同时也支持全托管模式的服务，赋能服务商托管其客户资源。">
  <title>NATS社区版服务实例部署文档 - Aliyun 计算巢</title>

  <link rel="shortcut icon" href="img/favicon.ico">

  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
  <link rel="stylesheet" href="css/theme.css">
  

  

  
  

  
    <script src="search/main.js"></script>
  

  

  <script src="js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body>
  <div class="container">
    <div class="nav">
      <div class="nav-inner">
        <div class="logo">
          <img src="./img/logo-2x.png">
        </div>
        <div class="nav-list">
          <ul>
          
              <li><a href="#nats">NATS社区版服务实例部署文档</a></li>
              
          
              <li><a href="#_1">概述</a></li>
              
          
              <li><a href="#_2">计费说明</a></li>
              
          
              <li><a href="#_3">部署架构</a></li>
              
          
              <li><a href="#_4">所需权限</a></li>
              
          
              <li><a href="#_5">部署流程</a></li>
              
                  <li><a href="#_6">参数说明</a></li>
                  
              
                  <li><a href="#_7">部署步骤</a></li>
                  
              
          
              <li><a href="#_8">集群配置探查</a></li>
              
          
              <li><a href="#nats_1">NATS 集群实践</a></li>
              
                  <li><a href="#context">创建context</a></li>
                  
              
                  <li><a href="#_9">创建流</a></li>
                  
              
                  <li><a href="#_10">发布消息</a></li>
                  
              
                  <li><a href="#_11">创建消费者</a></li>
                  
              
                  <li><a href="#_12">消费消息</a></li>
                  
              
                  <li><a href="#_13">多实例消费</a></li>
                  
              
                  <li><a href="#_14">查看流状态</a></li>
                  
              
                  <li><a href="#_15">高可用验证</a></li>
                  
              
          
              <li><a href="#_16">下一步</a></li>
              
          
              <li><a href="#_17">参考文档</a></li>
              
          
          </ul>
        </div>
      </div>
    </div>
    <div class="content theme-github">
      
      <div class="content-inner">        
        
        <h1 id="nats">NATS社区版服务实例部署文档</h1>
<!-- vim-markdown-toc GFM -->

<ul>
<li><a href="#概述">概述</a></li>
<li><a href="#计费说明">计费说明</a></li>
<li><a href="#部署架构">部署架构</a></li>
<li><a href="#所需权限">所需权限</a></li>
<li><a href="#部署流程">部署流程</a><ul>
<li><a href="#参数说明">参数说明</a></li>
<li><a href="#部署步骤">部署步骤</a></li>
</ul>
</li>
<li><a href="#集群配置探查">集群配置探查</a></li>
<li><a href="#nats-集群实践">NATS 集群实践</a><ul>
<li><a href="#创建context">创建context</a></li>
<li><a href="#创建流">创建流</a></li>
<li><a href="#发布消息">发布消息</a></li>
<li><a href="#创建消费者">创建消费者</a></li>
<li><a href="#消费消息">消费消息</a></li>
<li><a href="#多实例消费">多实例消费</a></li>
<li><a href="#查看流状态">查看流状态</a></li>
<li><a href="#高可用验证">高可用验证</a></li>
</ul>
</li>
<li><a href="#下一步">下一步</a></li>
<li><a href="#参考文档">参考文档</a></li>
</ul>
<!-- vim-markdown-toc -->
<h1 id="_1">概述</h1>
<p>NATS是一个开源、轻量级、高性能的分布式消息中间件。</p>
<p>随着NATS2.0的出现，NATS生态得到了极大的发展，NATS 2.0提供了分布式安全、去中心化管理、多租户、更大的网络、全球可扩展以及安全的数据共享。但NATS流在适应NATS 2.0方面存在很多限制，而且流系统还没有发展到能够应对下一代物联网和边缘计算的挑战。</p>
<p>NATS 2.0的下一代NATS流系统被称为NATS JetStream，具有分布式安全、多租户和水平扩展能力。</p>
<p>计算巢上提供了NATS社区版服务，您无需自行配置云主机，即可在计算巢上快速部署NATS服务、实现运维监控，从而方便地基于NATS搭建您自己云原生、分布式、微服务架构的业务应用。</p>
<p>本文向您介绍如何开通计算巢上的NATS社区版服务，以及部署流程和使用说明。</p>
<h1 id="_2">计费说明</h1>
<p>NATS社区版在计算巢上的费用主要涉及：</p>
<ul>
<li>所选vCPU与内存规格</li>
<li>磁盘容量</li>
<li>公网带宽(如果开启公网服务)</li>
</ul>
<p>计费方式包括：</p>
<ul>
<li>按量付费（小时）</li>
<li>包年包月</li>
</ul>
<p>预估费用在创建实例时可实时看到。</p>
<h1 id="_3">部署架构</h1>
<p>NATS社区版有单机部署和集群部署两种架构。</p>
<p>集群版目前可以支持选择3-11奇数个节点部署。</p>
<h1 id="_4">所需权限</h1>
<p>NATS服务需要对ECS、VPC等资源进行访问和创建操作，若您使用RAM用户创建服务实例，需要在创建服务实例前，对使用的RAM用户的账号添加相应资源的权限。
添加RAM权限的详细操作，请参见<a href="https://help.aliyun.com/document_detail/121945.html">为RAM用户授权</a>。所需权限如下表所示。</p>
<table>
<thead>
<tr>
<th>权限策略名称</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>AliyunECSFullAccess</td>
<td>管理云服务器服务（ECS）的权限</td>
</tr>
<tr>
<td>AliyunVPCFullAccess</td>
<td>管理专有网络（VPC）的权限</td>
</tr>
<tr>
<td>AliyunROSFullAccess</td>
<td>管理资源编排服务（ROS）的权限</td>
</tr>
<tr>
<td>AliyunComputeNestUserFullAccess</td>
<td>管理计算巢服务（ComputeNest）的用户侧权限</td>
</tr>
<tr>
<td>AliyunCloudMonitorFullAccess</td>
<td>管理云监控（CloudMonitor）的权限</td>
</tr>
</tbody>
</table>
<h1 id="_5">部署流程</h1>
<p>本文档演示部署集群版的流程。</p>
<h2 id="_6">参数说明</h2>
<p>您在创建服务实例的过程中，需要配置服务实例信息。下文介绍ZooKeeper社区版服务实例输入参数的详细信息。</p>
<table>
<thead>
<tr>
<th>参数组</th>
<th>参数项</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>选择模板</td>
<td>模板选择</td>
<td>集群版</td>
<td>模板架构类型</td>
</tr>
<tr>
<td>服务实例名称</td>
<td></td>
<td>test</td>
<td>实例的名称</td>
</tr>
<tr>
<td>地域</td>
<td></td>
<td>华东1（杭州）</td>
<td>选中服务实例的地域，建议就近选中，以获取更好的网络延时。</td>
</tr>
<tr>
<td>可用区配置</td>
<td>部署区域</td>
<td>可用区I</td>
<td>地域下的不同可用区域</td>
</tr>
<tr>
<td>付费类型配置</td>
<td>付费类型</td>
<td>按量付费 或 包年包月</td>
<td></td>
</tr>
<tr>
<td>选择已有基础资源配置</td>
<td>VPC ID</td>
<td>vpc-xxx</td>
<td>选择专有网络的ID。</td>
</tr>
<tr>
<td>选择已有基础资源配置</td>
<td>交换机ID</td>
<td>vsw-xxx</td>
<td>选择交换机ID。若找不到交换机, 可尝试切换地域和可用区</td>
</tr>
<tr>
<td>ECS实例配置</td>
<td>实例类型</td>
<td>ecs.g7.large</td>
<td>实例规格，可以根据实际需求选择</td>
</tr>
<tr>
<td>ECS实例配置</td>
<td>系统盘空间</td>
<td>40</td>
<td>系统盘空间，可以根据实际需求选择</td>
</tr>
<tr>
<td>ECS实例配置</td>
<td>数据盘空间</td>
<td>40</td>
<td>数据盘空间，可以根据实际需求选择</td>
</tr>
<tr>
<td>ECS实例配置</td>
<td>实例密码</td>
<td><strong><em>*</em></strong>*</td>
<td>设置实例密码。长度8~30个字符，必须包含三项（大写字母、小写字母、数字、()`~!@#$%^&amp;*-+={}[]:;'&lt;&gt;,.?/ 中的特殊符号）</td>
</tr>
<tr>
<td>ECS实例配置</td>
<td>开启公网IP</td>
<td>true</td>
<td>是否开启公网IP</td>
</tr>
<tr>
<td>NATS配置</td>
<td>集群节点数</td>
<td>3</td>
<td>集群版节点数</td>
</tr>
<tr>
<td>NATS配置</td>
<td>admin密码</td>
<td><strong>*</strong></td>
<td>默认admin用户的密码22-30字符</td>
</tr>
</tbody>
</table>
<h2 id="_7">部署步骤</h2>
<p>单击<a href="https://computenest.console.aliyun.com/user/cn-hangzhou/serviceInstanceCreate?ServiceId=service-c63f342f7c7f48e8bbb5">部署链接</a>，
进入服务实例部署界面，根据界面提示，可以选择默认的部署模板，快速部署，也可以使用自定义模板，对一些参数进行个性化配置。</p>
<p>详细的部署页面如下：</p>
<p><img alt="create-instance-first-page.png" src="create-instance-first-page.jpg" /></p>
<p>便捷的方式是选择默认的套餐，然后只需要选择可用区、选择VPC信息、配置实例密码、NATS密码点击即可进行集群创建。</p>
<p><img alt="img.png" src="img.png" /></p>
<p>等待大约1分钟，状态变为「已部署」时，集群即完成创建。
<img alt="img_1.png" src="img_1.png" />
此时点击服务实例名称连接，进入连接页面：</p>
<p><img alt="img_2.png" src="img_2.png" /></p>
<p>可以看到公网和私网访问页面。</p>
<p>下面演示通过公网地址操作NATS.</p>
<h1 id="_8">集群配置探查</h1>
<p>nats 配置文件</p>
<pre><code class="language-bash">[root@iZbp139ju1kmizva7adgdbZ ~]# cat /etc/nats/nats.conf 
server_name=iZbp139ju1kmizva7adgdbZ-172-16-0-155
listen: 0.0.0.0:4222
http: 8222
accounts {
  $SYS {
    users = [
      { user: &quot;admin&quot;,
        pass: &quot;$2a$11$GUizXsS82Y.dll.uZXDic.qMDePF2IT6d3t5iWIs.rQ3lY1p6mDKC&quot;
      }
    ]
  }
}

jetstream {
   store_dir=/data/nats-storage
}

cluster {
  name: C1
  listen: 0.0.0.0:4248
  routes = [

      nats-route://172.16.0.155:4248
      nats-route://172.16.0.157:4248
      nats-route://172.16.0.156:4248
  ]
}

</code></pre>
<p>从配置可以看到默认启用了JetStream特性，持久化目录存储在数据盘/data下</p>
<pre><code class="language-bash">[root@iZbp19f7ptaaw66l28h5bnZ ~]# df -h
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        3.8G     0  3.8G   0% /dev
tmpfs           3.8G     0  3.8G   0% /dev/shm
tmpfs           3.8G  512K  3.8G   1% /run
tmpfs           3.8G     0  3.8G   0% /sys/fs/cgroup
/dev/vda1        40G  2.5G   35G   7% /
/dev/vdb1        40G   49M   38G   1% /data
tmpfs           768M     0  768M   0% /run/user/0
[root@iZbp19f7ptaaw66l28h5bnZ ~]# tree /data/nats-storage/
/data/nats-storage/
└── jetstream
    ├── $G
    │   └── streams
    │       └── my_stream
    │           ├── meta.inf
    │           ├── meta.sum
    │           ├── msgs
    │           │   ├── 1.blk
    │           │   ├── 1.fss
    │           │   └── 1.idx
    │           └── obs
    │               ├── foo_comsumer
    │               │   ├── meta.inf
    │               │   ├── meta.sum
    │               │   └── o.dat
    │               ├── foo_consumer
    │               │   ├── meta.inf
    │               │   ├── meta.sum
    │               │   └── o.dat
    │               └── foo_consumer2
    │                   ├── meta.inf
    │                   ├── meta.sum
    │                   └── o.dat
</code></pre>
<p>nats 使用systemd启动配置如下：</p>
<pre><code class="language-bash">
$ cat /etc/systemd/system/natsd.service 
[Unit]
Description=natsd.service

[Service]
Type=simple
ExecStart=/usr/bin/nats-server --config /etc/nats/nats.conf
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
</code></pre>
<h1 id="nats_1">NATS 集群实践</h1>
<h2 id="context">创建context</h2>
<pre><code class="language-shell">$ nats context save computenest-nats --server nats://47.98.102.138:4222,nats://47.98.102.138:4222,nats://47.98.102.138:4222 --description 'ComputeNest NATS Cluster' --select
NATS Configuration Context &quot;computenest-nats&quot;

Description: ComputeNest NATS Cluster
Server URLs: nats://47.98.102.138:4222,nats://47.98.102.138:4222,nats://47.98.102.138:4222
Path: /root/.config/nats/context/computenest-nats.json
Connection: OK

$ nats context ls
╭──────────────────────────────────────────────╮
│                Known Contexts                │
├───────────────────┬──────────────────────────┤
│ Name              │ Description              │
├───────────────────┼──────────────────────────┤
│ computenest-nats* │ ComputeNest NATS Cluster │
│ local             │ Local Host               │
╰───────────────────┴──────────────────────────╯
</code></pre>
<p>接下来所有的步骤都默认会使用上面配置的计算巢 NATS 集群.</p>
<h2 id="_9">创建流</h2>
<pre><code class="language-bash">$ nats stream add my_stream
? Subjects foo
? Storage file
? Replication 3
? Retention Policy Limits
? Discard Policy Old
? Stream Messages Limit -1
? Per Subject Messages Limit -1
? Total Stream Size -1
? Message TTL -1
? Max Message Size -1
? Duplicate tracking time window 2m0s
? Allow message Roll-ups No
? Allow message deletion Yes
? Allow purging subjects or the entire stream Yes

Stream my_stream was created

Information for Stream my_stream created 2023-04-09 08:28:33

             Subjects: foo
             Replicas: 3
              Storage: File

Options:

            Retention: Limits
     Acknowledgements: true
       Discard Policy: Old
     Duplicate Window: 2m0s
    Allows Msg Delete: true
         Allows Purge: true
       Allows Rollups: false

Limits:

     Maximum Messages: unlimited
  Maximum Per Subject: unlimited
        Maximum Bytes: unlimited
          Maximum Age: unlimited
 Maximum Message Size: unlimited
    Maximum Consumers: unlimited


Cluster Information:

                 Name: C1
               Leader: iZbp139ju1kmizva7adgdcZ-172-16-0-157
              Replica: iZbp139ju1kmizva7adgdbZ-172-16-0-155, current, seen 0.00s ago
              Replica: iZbp139ju1kmizva7adgddZ-172-16-0-156, current, seen 0.00s ago

State:

             Messages: 0
                Bytes: 0 B
             FirstSeq: 0
              LastSeq: 0
     Active Consumers: 0

</code></pre>
<p><strong>注意事项：</strong></p>
<ul>
<li>Replication 配置为3，指明创建的流具备三个副本的高可用版本，NATS 会基于RAFT协议进行数据备份实现高可用</li>
</ul>
<h2 id="_10">发布消息</h2>
<p>本部分使用<code>nats pub</code>命令进行发布消息</p>
<pre><code class="language-bash">$ nats pub foo --count=1000 --sleep 1s &quot;publication #{{Count}} @ {{TimeStamp}}&quot;
 27 / 1000 [====&gt;--------------------------------------------] 26 

</code></pre>
<h2 id="_11">创建消费者</h2>
<p>要消费消息，首先要创建消费者：</p>
<pre><code class="language-bash">$ nats consumer add
? Consumer name foo_consumer
? Delivery target (empty for Pull Consumers) 
? Start policy (all, new, last, subject, 1h, msg sequence) all
? Acknowledgement policy explicit
? Replay policy instant
? Filter Stream by subject (blank for all) 
? Maximum Allowed Deliveries -1
? Maximum Acknowledgements Pending 0
? Deliver headers only without bodies No
? Add a Retry Backoff Policy No
? Select a Stream my_stream
Information for Consumer my_stream &gt; foo_consumer created 2023-04-09T08:31:23+08:00

Configuration:

        Durable Name: foo_consumer
           Pull Mode: true
      Deliver Policy: All
          Ack Policy: Explicit
            Ack Wait: 30s
       Replay Policy: Instant
     Max Ack Pending: 1,000
   Max Waiting Pulls: 512

Cluster Information:

                Name: C1
              Leader: iZbp139ju1kmizva7adgddZ-172-16-0-156
             Replica: iZbp139ju1kmizva7adgdbZ-172-16-0-155, current, not seen
             Replica: iZbp139ju1kmizva7adgdcZ-172-16-0-157, current, seen 0.00s ago

State:

   Last Delivered Message: Consumer sequence: 0 Stream sequence: 0
     Acknowledgment floor: Consumer sequence: 0 Stream sequence: 0
         Outstanding Acks: 0 out of maximum 1,000
     Redelivered Messages: 0
     Unprocessed Messages: 45
            Waiting Pulls: 0 of maximum 512


</code></pre>
<h2 id="_12">消费消息</h2>
<p>创建完消费者后就可以进行消费数据：</p>
<pre><code class="language-bash">$ nats consumer next my_stream foo_consumer --count 1000
[09:05:18] subj: foo / tries: 1 / cons seq: 1 / str seq: 1 / pending: 27

publication #1 @ 2023-04-06T15:17:18+08:00

Acknowledged message

[09:05:18] subj: foo / tries: 1 / cons seq: 2 / str seq: 2 / pending: 26

publication #2 @ 2023-04-06T15:17:19+08:00

Acknowledged message

[09:05:18] subj: foo / tries: 1 / cons seq: 3 / str seq: 3 / pending: 25
...
</code></pre>
<h2 id="_13">多实例消费</h2>
<p>多实例消费演示多个实例同时消费一个topic时，NATS 会进行一定的负载均衡保证每个启动的实例均分生产的消息，这在实际业务中可以做负载均衡，消费者水平扩展。</p>
<p>消费实例1:</p>
<pre><code class="language-bash">$ nats consumer next my_stream foo_consumer --count 1000
...
[08:33:45] subj: foo / tries: 1 / cons seq: 186 / str seq: 186 / pending: 0

publication #186 @ 2023-04-09T08:33:45+08:00

Acknowledged message

[08:33:47] subj: foo / tries: 1 / cons seq: 188 / str seq: 188 / pending: 0

publication #188 @ 2023-04-09T08:33:47+08:00

Acknowledged message

[08:33:49] subj: foo / tries: 1 / cons seq: 190 / str seq: 190 / pending: 0

publication #190 @ 2023-04-09T08:33:49+08:00

Acknowledged message

[08:33:51] subj: foo / tries: 1 / cons seq: 192 / str seq: 192 / pending: 0

publication #192 @ 2023-04-09T08:33:51+08:00

Acknowledged message
...
</code></pre>
<p>消费实例2:</p>
<pre><code class="language-bash">$ nats consumer next my_stream foo_consumer --count 1000
[08:33:46] subj: foo / tries: 1 / cons seq: 187 / str seq: 187 / pending: 0

publication #187 @ 2023-04-09T08:33:46+08:00

Acknowledged message

[08:33:48] subj: foo / tries: 1 / cons seq: 189 / str seq: 189 / pending: 0

publication #189 @ 2023-04-09T08:33:48+08:00

Acknowledged message

[08:33:50] subj: foo / tries: 1 / cons seq: 191 / str seq: 191 / pending: 0

publication #191 @ 2023-04-09T08:33:50+08:00

Acknowledged message

[08:33:52] subj: foo / tries: 1 / cons seq: 193 / str seq: 193 / pending: 0

publication #193 @ 2023-04-09T08:33:52+08:00

Acknowledged message

</code></pre>
<h2 id="_14">查看流状态</h2>
<pre><code class="language-bash">$ nats stream info my_stream
nats stream info my_stream
Information for Stream my_stream created 2023-04-09 08:28:33

             Subjects: foo
             Replicas: 3
              Storage: File

Options:

            Retention: Limits
     Acknowledgements: true
       Discard Policy: Old
     Duplicate Window: 2m0s
    Allows Msg Delete: true
         Allows Purge: true
       Allows Rollups: false

Limits:

     Maximum Messages: unlimited
  Maximum Per Subject: unlimited
        Maximum Bytes: unlimited
          Maximum Age: unlimited
 Maximum Message Size: unlimited
    Maximum Consumers: unlimited


Cluster Information:

                 Name: C1
               Leader: iZbp139ju1kmizva7adgdcZ-172-16-0-157
              Replica: iZbp139ju1kmizva7adgdbZ-172-16-0-155, current, seen 0.85s ago
              Replica: iZbp139ju1kmizva7adgddZ-172-16-0-156, current, seen 0.85s ago

State:

             Messages: 350
                Bytes: 26 KiB
             FirstSeq: 1 @ 2023-04-09T00:30:38 UTC
              LastSeq: 350 @ 2023-04-09T00:36:30 UTC
     Active Consumers: 1
   Number of Subjects: 1

</code></pre>
<p>说明：</p>
<ul>
<li>可以看到流的副本数为3</li>
<li>集群信息部分可以看到node2-c1 这个节点是Leader，node1、node3是Follower</li>
</ul>
<p>下一步将node2节点宕机观看流的情况。</p>
<h2 id="_15">高可用验证</h2>
<p>通过查看流的状态发现创建的流的leader节点是"iZbp139ju1kmizva7adgdcZ-172-16-0-157"，
现在将此节点关机:
<img alt="image.png" src="https://intranetproxy.alipay.com/skylark/lark/0/2023/png/47856458/1681000781622-911f1b06-a124-4ef7-b87a-d9fa06d7e696.png#clientId=u1990f917-71c5-4&amp;from=paste&amp;height=528&amp;id=u73b2dcea&amp;name=image.png&amp;originHeight=528&amp;originWidth=624&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=183094&amp;status=done&amp;style=none&amp;taskId=uae38fc12-de2c-46f4-b5e3-57b72afd96d&amp;title=&amp;width=624" />
之后再查看流的状态</p>
<pre><code class="language-bash">$ nats stream info my_stream
Information for Stream my_stream created 2023-04-09 08:28:33

             Subjects: foo
             Replicas: 3
              Storage: File

Options:

            Retention: Limits
     Acknowledgements: true
       Discard Policy: Old
     Duplicate Window: 2m0s
    Allows Msg Delete: true
         Allows Purge: true
       Allows Rollups: false

Limits:

     Maximum Messages: unlimited
  Maximum Per Subject: unlimited
        Maximum Bytes: unlimited
          Maximum Age: unlimited
 Maximum Message Size: unlimited
    Maximum Consumers: unlimited


Cluster Information:

                 Name: C1
               Leader: iZbp139ju1kmizva7adgddZ-172-16-0-156
              Replica: iZbp139ju1kmizva7adgdbZ-172-16-0-155, current, seen 0.38s ago
              Replica: iZbp139ju1kmizva7adgdcZ-172-16-0-157, outdated, OFFLINE, seen 20.64s ago, 548 operations behind

State:

             Messages: 545
                Bytes: 41 KiB
             FirstSeq: 1 @ 2023-04-09T00:30:38 UTC
              LastSeq: 545 @ 2023-04-09T00:39:46 UTC
     Active Consumers: 1
   Number of Subjects: 1

</code></pre>
<p>可以看到集群状态部分 156号节点变成新的Leader，157状态为OFFLINE。</p>
<p>此时创建新的消费者重新消费数据：</p>
<pre><code class="language-bash">nats consumer add
? Consumer name foo_consumer2
? Delivery target (empty for Pull Consumers) 
? Start policy (all, new, last, subject, 1h, msg sequence) all
? Acknowledgement policy explicit
? Replay policy instant
? Filter Stream by subject (blank for all) 
? Maximum Allowed Deliveries -1
? Maximum Acknowledgements Pending 0
? Deliver headers only without bodies No
? Add a Retry Backoff Policy No
? Select a Stream my_stream

Information for Consumer my_stream &gt; foo_consumer2 created 2023-04-09T08:42:07+08:00

Configuration:

        Durable Name: foo_consumer2
           Pull Mode: true
      Deliver Policy: All
          Ack Policy: Explicit
            Ack Wait: 30s
       Replay Policy: Instant
     Max Ack Pending: 1,000
   Max Waiting Pulls: 512

Cluster Information:

                Name: C1
              Leader: iZbp139ju1kmizva7adgdbZ-172-16-0-155
             Replica: iZbp139ju1kmizva7adgdcZ-172-16-0-157, outdated, not seen
             Replica: iZbp139ju1kmizva7adgddZ-172-16-0-156, current, seen 0.00s ago

State:

   Last Delivered Message: Consumer sequence: 0 Stream sequence: 0
     Acknowledgment floor: Consumer sequence: 0 Stream sequence: 0
         Outstanding Acks: 0 out of maximum 1,000
     Redelivered Messages: 0
     Unprocessed Messages: 685
            Waiting Pulls: 0 of maximum 512

$ nats consumer next my_stream foo_consumer2 --count 3
[08:42:27] subj: foo / tries: 1 / cons seq: 1 / str seq: 1 / pending: 703

publication #1 @ 2023-04-09T08:30:38+08:00

Acknowledged message

[08:42:27] subj: foo / tries: 1 / cons seq: 2 / str seq: 2 / pending: 702

publication #2 @ 2023-04-09T08:30:39+08:00

Acknowledged message

[08:42:27] subj: foo / tries: 1 / cons seq: 3 / str seq: 3 / pending: 701

publication #3 @ 2023-04-09T08:30:40+08:00

Acknowledged message
</code></pre>
<p>此时故障节点恢复之后：重新查看流的状态：</p>
<pre><code class="language-bash">$  nats stream info my_stream
Information for Stream my_stream created 2023-04-09 08:28:33

             Subjects: foo
             Replicas: 3
              Storage: File

Options:

            Retention: Limits
     Acknowledgements: true
       Discard Policy: Old
     Duplicate Window: 2m0s
    Allows Msg Delete: true
         Allows Purge: true
       Allows Rollups: false

Limits:

     Maximum Messages: unlimited
  Maximum Per Subject: unlimited
        Maximum Bytes: unlimited
          Maximum Age: unlimited
 Maximum Message Size: unlimited
    Maximum Consumers: unlimited


Cluster Information:

                 Name: C1
               Leader: iZbp139ju1kmizva7adgddZ-172-16-0-156
              Replica: iZbp139ju1kmizva7adgdbZ-172-16-0-155, current, seen 0.22s ago
              Replica: iZbp139ju1kmizva7adgdcZ-172-16-0-157, current, seen 0.22s ago

State:

             Messages: 780
                Bytes: 58 KiB
             FirstSeq: 1 @ 2023-04-09T00:30:38 UTC
              LastSeq: 780 @ 2023-04-09T00:43:43 UTC
     Active Consumers: 2
   Number of Subjects: 1

</code></pre>
<p>可以看到流的集群信息三个节点全部变为可用状态，刚异常的node2节点恢复了,加入之前两个健康节点的集群后自动变成了follower。</p>
<h1 id="_16">下一步</h1>
<p>NATS 目前逐步演变为一个生态，可以实践、演示的功能还非常多，包括单不限于以下方面：</p>
<ul>
<li><strong>安全认证</strong>：支持Token、user/pass、TLS、NKEY、JWT等安全配置</li>
<li><strong>连接协议</strong>：除了基于默认的nats 连接协议外，还支持WebSocket、MQTT连接，并且可以通过Kafka Bridge JMS 将其他消息系统的流量转到NATS</li>
<li>JetStream <a href="https://docs.nats.io/nats-concepts/jetstream">更多的功能</a>：JetStream 是NATS最新一代的高可用流式系统，支持非常多的高级特性：</li>
<li>流重放策略</li>
<li>流式存储</li>
<li>保留策略</li>
<li>消息配额</li>
<li>持久化</li>
<li>流Mirror</li>
<li>双端流控</li>
<li>Exactly-Once语义支持</li>
<li><strong>多租户管理</strong>：基于<a href="https://docs.nats.io/using-nats/nats-tools/nsc">nsc</a>工具进行多租户账号配置管理</li>
<li><strong>边缘场景</strong>：为了支持边缘计算、IOT场景，NATS支持在边缘部署本地的NATS集群，跟中心集群交互。使得边缘设备可以通过连接边缘本地集群快速进行业务数据的生产，不会强依赖跟远端中心集群的网络稳定性，边缘场景<a href="https://docs.nats.io/running-a-nats-service/configuration/leafnodes">参考</a>。</li>
</ul>
<h1 id="_17">参考文档</h1>
<p>[1]: nats cluster creation: <a href="https://docs.nats.io/running-a-nats-service/nats_docker#creating-a-nats-cluster">https://docs.nats.io/running-a-nats-service/nats_docker#creating-a-nats-cluster</a></p>
<p>[2]: jetString cluster: <a href="https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering">https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering</a></p>
<p>[3]: js walkthrough： <a href="https://docs.nats.io/nats-concepts/jetstream/js_walkthrough">https://docs.nats.io/nats-concepts/jetstream/js_walkthrough</a></p>
<p>[4]: <a href="https://www.jianshu.com/p/27a49b9d4306">基于NATS JetStream构建分布式事件流系统</a></p>
        
      </div>

      <div class="copyrights">© 2009-2022 Aliyun.com 版权所有</div>
    </div>
  </div>
  
  <!--
  MkDocs version      : 1.5.3
  Docs Build Date UTC : 2023-11-09 11:52:04.433871+00:00
  -->
</body>
</html>